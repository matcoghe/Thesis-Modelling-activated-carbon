library(readxl)
library(shiny)
library(shinythemes)
library(deSolve)
library(orthopolynom)
library(plotly)
library(shinyjs)
library(tidyr)
library(DataEditR)
library(shinyWidgets)
library(colorBlindness)
library(xlsx)

#------------------------------------------------------------------------------#
#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#

#HSDMIX_Solve is the engine that runs the Ion Exchange Model. The user inputs
#a parameter data frame (params), an ion data frame (ions), concentration
#data frame (Cin), and an input time which takes the form of a selectInput later
#In the code. nt_report for now is 201, meaning that there are 201 data points
#for each chemical, although this may be changed later to be an input.
#------------------------------------------------------------------------------#




#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
#------------------------------------------------------------------------------#
                          #unit conversions
#------------------------------------------------------------------------------#
## length
m2cm<-100                               #meters to centimeters
mm2cm<-0.1                              #millimeters to centimeters
cm2cm<-1                                #centimeters to centimeters (for consistency)
in2cm<-2.54                             #inches to centimeters
ft2cm<-12 * in2cm                       #centimeters to feet
## time
sec2sec<-1
min2sec<-60
S_PER_HR <- 60 * 60                     # seconds per hour  #used by HSDMIX function
hour2sec<-60 * min2sec
day2sec<-24 * hour2sec
month2sec<-30 * day2sec                 #assumes 30 day month
year2sec<-365.25 * day2sec
## velocity
mpmin2cmps<-m2cm/min2sec                #meters per minute to centimeters per second
ftpmin2cmps<-ft2cm/min2sec              #feet per minute to centimeters per second
mph2cmps<-m2cm/hour2sec                 #meters per hour to centimeters per second
mmin2cms<-m2cm/min2sec
ftmin2cms<-ft2cm/min2sec
gal2ft3<-0.133680555556
gpmpft2cmps<-gal2ft3 * ft2cm / min2sec  #gallons per minute per foot squared
ft2ps2cm2ps<-(ft2cm)^2                  #feet squared per second to centimeters squared per second
m2ps2cm2ps<-(m2cm)^2                    #meters per second squared to centimeters per second squared
in2ps2cm2ps<-(in2cm)^2                  #inches per second squared to centimeters per second squared
ft2pm2cm2ps<-(ft2cm)^2 / (min2sec)      #feet per minute squared to centimeters per second squared
m2min2cm2s<-(m2cm^2) / (min2sec) 
## volume
gal2ml<-3785.411784
mgd2mlps<-1e6 * gal2ml/day2sec          #mgd to ml/sec
l2ml <- 1000.

#~~~~~~~~~~~~~~~~~~~ end unit conversions

#------------------------------------------------------------------------------#
                          #conversion dictionaries
#------------------------------------------------------------------------------#
##set up dictionaries   ### IF new values are added to drop-downs, must also be added here
length_conv <- c("m"=m2cm, "cm"=cm2cm, "mm"=mm2cm, "in"=in2cm, "ft"=ft2cm)
velocity_conv <- c("cm/s"=cm2cm, "m/s"=m2cm, "m/min"=mpmin2cmps, "m/h"=mph2cmps,
                   "m/hr"=mph2cmps, "in/s"=in2cm, "ft/s"=ft2cm, "ft/min"=ftpmin2cmps,
                   "gpm/ft^2"=gpmpft2cmps)
volumetric_conv <- c("cm^3/s"=cm2cm, "m^3/s"=m2cm^3, "ft^3/s"=ft2cm^3, 
                     "mL/s"=cm2cm, "L/min"=l2ml/min2sec, "mL/min"=1/min2sec,
                     "gpm"=gal2ml/min2sec, "mgd"=mgd2mlps)
time_conv <- c("Hours"=hour2sec, "Days"=day2sec, "Months"=month2sec, "Years"=year2sec,
               "hr"=hour2sec, "day"=day2sec, "month"=month2sec, "year"=year2sec)

kL_conv <- c("ft/s"=ft2cm, "m/s"=m2cm, "cm/s"=cm2cm, "in/s"=in2cm, 
             "m/min"=mpmin2cmps, "ft/min"=ftpmin2cmps, "m/h"=mph2cmps,
             "m/hr"=mph2cmps)
ds_conv <- c("ft^2/s"=ft2ps2cm2ps, "m^2/s"=m2ps2cm2ps, "cm^2/s"=cm2cm,
             "in^2/s"=in2ps2cm2ps)

mass_conv <- c("mg"=1, "ug"=1e-3, "ng"=1e-6, "mg/L"=1, "ug/L"=1e-3, "ng/L"=1e-6)

lengthvector<-c("cm", "m", "mm", "in", "ft")
velocityvector<-c("cm/s", "m/s", "m/min", "m/h", "in/s","ft/s","ft/min", "gpm/ft^2")
timevector <- c("hr","day")
flowratevector<-c("cm^3/s", "m^3/s", "ft^3/s", "mL/s", "L/min", "mL/min", "gpm", "mgd")
diametervector<-c("cm", "m", "mm", "in", "ft")


#------------------------------------------------------------------------------#
                                #HSDMIX Function
#------------------------------------------------------------------------------#

# Inputs ----
nt_report = 201 # number of reporting steps

rad_colloc <- function(N){
  # For a grid of N collocation points.
  # Calculate B (madrix operator for 1-D radial Laplacian for a symmetric sphere)
  # and W (vector Gauss-Radau quadrature weights)
  # Ref: Villadsen, J., & Michelsen, M. L. (1978)
  
  # calculate number of interior collocation points symmetric around x = 0
  N_int <- N - 1
  
  # setup roots
  # get list of recurrence relations for the Jacobi polynomial (0, 1)
  # "p" is on the interval of -1 to 1
  # "g" is on the interval of 0 to 1 (i.e., shifted)
  # 1,1 is shifted legendre from python with 0
  # 2.5, 1.5 is spherical symmetry
  # 2.0, 1.0 is cylinder symmetry
  # 1.5, 0.5 is slab symmetry
  p_list <- jacobi.g.recurrences(N_int, 2.5, 1.5)
  
  # using the recurrence relations, construct monic orthogonal polynomials
  m.r <- monic.polynomial.recurrences(p_list)
  
  # returns roots of the monic orthogonal polynomials
  # take square root as the problem is symmetrical and roots are taken as x^2 terms
  # terms at zero and 1
  roots_non_sym <- c(rev(polynomial.roots(m.r)[[N]]), 1)
  
  # create a data.frame to store values
  derivatives <- data.frame(
    roots = roots_non_sym,
    p_1 = rep(0, N),
    p_2 = rep(0, N),
    p_3 = rep(0, N)
  )
  
  # set initial values
  p_1 <- c(1, rep(0, N-1))
  p_2 <- rep(0, N)
  p_3 <- rep(0, N)
  
  for (i in 1:N) {
    
    # set roots of interest
    x_i <- derivatives$roots[i]
    
    # set other roots to use
    j_values <- derivatives$roots[!derivatives$roots %in% x_i]
    
    # get deltas
    delta <- x_i - j_values
    
    for (j in 1:N_int) {
      
      # calculate derivatives for each j (i.e., other roots)
      p_1[j+1] <- delta[j] * p_1[j]
      p_2[j+1] <- delta[j] * p_2[j] + 2 * p_1[j]
      p_3[j+1] <- delta[j] * p_3[j] + 3 * p_2[j]
      
    }
    
    derivatives$p_1[i] <- p_1[N]
    derivatives$p_2[i] <- p_2[N]
    derivatives$p_3[i] <- p_3[N]
    
  }
  
  # define zero matrices
  Ar <- matrix(data = 0, N, N)
  Ar_sym <- matrix(data = 0, N, N)
  Br <- matrix(data = 0, N, N)
  Br_sym <- matrix(data = 0, N, N)
  
  # define A matrix values
  for (j in 1:N) {
    
    for (i in 1:N) {
      
      if(i == j) {
        Ar[i, j] <- 1 / 2 * derivatives$p_2[i] / derivatives$p_1[i]
      } else {
        Ar[i, j] <- 1 / (derivatives$roots[i] - derivatives$roots[j]) * derivatives$p_1[i] / derivatives$p_1[j]
      }
      
      # get symmertic equivalent
      Ar_sym[i, j] <- 2 * sqrt(derivatives$roots[i]) * Ar[i, j]
    }
  }
  
  # define B matrix values
  for (j in 1:N) {
    
    for (i in 1:N) {
      
      if(i == j) {
        Br[i, j] <- 1 / 3 * derivatives$p_3[i] / derivatives$p_1[i]
      } else {
        Br[i, j] <- 2 * Ar[i, j] * (Ar[i, i] - 1 / (derivatives$roots[i] - derivatives$roots[j]))
      }
      
      # get symmertic equivalent
      Br_sym[i, j] <- 4 * derivatives$roots[i] * Br[i, j] + 2 * 3 * Ar[i, j]
    }
  }
  
  # add roots for the symmetric case
  derivatives$roots_sym <- derivatives$roots^(1/2)
  
  # Manuscript formula (adjusted)
  a_weight <- 2
  derivatives$w_i_prime <- 1/(derivatives$roots * derivatives$p_1^2)
  derivatives$W_i_manu <- 1 / (a_weight + 1) * derivatives$w_i_prime * 1 / sum(derivatives$w_i_prime)
  
  B <- Br_sym
  W <- derivatives$W_i_manu
  
  return(list(B, W))
}

ax_colloc <- function(NZ) {
  NZ_int <- NZ - 2 # number of interior points.
  p_list = jacobi.g.recurrences(NZ_int, 1.0, 1.0)  # Shifted Legendre Poly
  m.r <-monic.polynomial.recurrences(p_list)
  roots_Z <- c(0, rev(polynomial.roots(m.r)[[NZ-1]]), 1)
  
  # create a data.frame to store values
  derivatives <- data.frame(
    roots = roots_Z,
    p_1 = rep(0, NZ),
    p_2 = rep(0, NZ),
    p_3 = rep(0, NZ)
  )
  
  # set initial values
  p_1 <- c(1, rep(0, NZ-1))
  p_2 <- rep(0, NZ)
  p_3 <- rep(0, NZ)
  
  for (i in 1:NZ) {
    
    # set roots of interest
    x_i <- derivatives$roots[i]
    
    # set other roots to use
    j_values <- derivatives$roots[!derivatives$roots %in% x_i]
    
    # get deltas
    delta <- x_i - j_values
    
    for (j in 1:(NZ-1)) {
      
      # calculate derivatives for each j (i.e., other roots)
      p_1[j+1] <- delta[j] * p_1[j]
      p_2[j+1] <- delta[j] * p_2[j] + 2 * p_1[j]
      p_3[j+1] <- delta[j] * p_3[j] + 3 * p_2[j]
      
    }
    
    derivatives$p_1[i] <- p_1[NZ]
    derivatives$p_2[i] <- p_2[NZ]
    derivatives$p_3[i] <- p_3[NZ]
    
  }
  
  # define zero matrices
  AZ <- matrix(data = 0, NZ, NZ)
  
  
  # define AZ matrix values
  for (j in 1:NZ) {
    
    for (i in 1:NZ) {
      
      if(i == j) {
        AZ[i, j] <- 1 / 2 * derivatives$p_2[i] / derivatives$p_1[i]
      } else {
        AZ[i, j] <- 1 / (derivatives$roots[i] - derivatives$roots[j]) * derivatives$p_1[i] / derivatives$p_1[j]
      }
    }
  }
  
  return(AZ)
  
}

# Solve function for Shiny App ----
HSDMIX_solve <- function (params, ions, Cin, inputtime, nt_report){
  
  NR <- filter(params, name == "nr")$value # numer of grid points along bead radius
  NZ <- filter(params, name == "nz")$value # number of grid points along column axis.
  
  Q <- filter(params, name == "Q")$value # meq/L in resin beads
  L <- filter(params, name == "L")$value # bed depth (cm)
  v <- filter(params, name == "v")$value # superficial flow velocity (cm/s)
  EBED <- filter(params, name == "EBED")$value # bed porosity
  rb <- filter(params, name == "rb")$value # bead radius (cm)
  
  # Ion info
  # Presaturant ion (reference ion A) listed first
  ion_names <- ions$name
  KxA <- ions$KxA
  valence <- ions$valence
  
  # mass transport paramters
  kL <- ions$kL # film transfer (cm/s)
  Ds <- ions$Ds # surface diffusion (sq. cm/s)
  
  # XXX: Obviously, we will want to load influent concentrations in a more R-idiomatic way.
  # This is basically Fortran77 :/.
  C_in_t <- data.matrix(Cin)
  
  # Derived parameters ----
  Nt_interp <- dim(C_in_t)[1]
  NION <- length(ion_names)
  LIQUID <- NR + 1 # mnemonic device
  
  C_in_t[, 1] <- C_in_t[, 1] * inputtime # convert time specification from hours to seconds
  
  
  t_max = C_in_t[Nt_interp, 1]
  times <- seq(0.0, t_max*0.99, length.out = nt_report) # seconds
  # times is just a bit short of hours_max to avoid problems with the interpolator.
  
  # XXX: Unfortunately, I can't find  whether deSolve has any way to provide the the timesteps the integrator actually takes
  # so we have to manually define the time scales for the inorganic ions and/or the longer eluting compounds.
  # This is super annoying for troubleshooting BDF or Radau computations
  # and really inefficient+inconvenient for stiff problems in general.
  
  C_in_0 <- C_in_t[1, 2:(NION+1)] # initial influent concentration (meq/L)
  CT <- sum(C_in_0) # total charge equivalent concentration in feed
  EBCT <- L/v # empty bed contact time.
  tc <- 1.0 # characteristic time # vestigial?
  NEQ <- (NR+1) * NION * NZ
  grid_dims = c((NR+1), NION, NZ)
  
  dv_ions <- valence == 2
  mv_ions <- valence == 1
  mv_ions[1] <- FALSE # exclude presaturant (refrence ion)
  
  # Interpolating functions ----
  # for tracking C_in during integration.
  interp_list <- vector(mode = "list", length = NION)
  for (ii in 1:NION){
    interp_list[[ii]] <- approxfun(C_in_t[ , 1], y = C_in_t[ , ii+1])
  }
  
  # Initialize grid ----
  # Liquid phase is index (NR+1)
  x0 <- array(0.0, grid_dims)
  x0[LIQUID, , 1] <- C_in_0 # set inlet concentrations
  x0[LIQUID, 1, 2:NZ] <- CT  # Rest of liquid in column is full of presaturant
  x0[1:NR, 1, ] <- Q # resin intially loaded with presaturant
  dim(x0) <- c(NEQ)
  
  # collocation ----
  colloc <- rad_colloc(NR)
  BR <- colloc[[1]]  # 1-d radial Laplacian
  WR <- colloc[[2]]  # Gauss-Radau quadrature weights
  AZ <- ax_colloc(NZ) # 1st derivative along Z
  
  
  # Derivative function ----
  diffun <- function(t, x, parms){
    
    dim(x) <- grid_dims
    C <- x[LIQUID, , ]
    q <- x[1:NR, , ]
    qs <- x[NR, , ]
    
    CT_test <- colSums(C)
    
    # update influent concentrations
    for (ii in 1:NION){
      C[ii, 1] <- interp_list[[ii]](t)
    }
    
    # advection collocation intermediate step
    AZ_C <- array(0.0, c(NION, NZ))
    for (ii in 1:NION) {
      AZ_C[ii, ] <- AZ%*%C[ii, ]
    }
    
    
    dx_dt <- array(0.0, grid_dims)
    
    C_star <- array(0.0, c(NION, NZ))
    if (2 %in% valence){
      # divalent isotherm
      for (ii in 2:NZ){
        cc <- -CT_test[ii]
        bb <- 1 + (1/qs[1, ii]) * sum(qs[mv_ions, ii]/KxA[mv_ions])
        aa <- (1/qs[1,ii]**2) * qs[dv_ions, ii] / KxA[dv_ions]
        denom <- -bb - sqrt(bb**2 - 4 * aa * cc)
        C_star[1, ii] <- 2 * cc / denom
      }
      
      for (ii in 2:NION){
        C_star[ii, 2:NZ] <- qs[ii, 2:NZ]/KxA[ii]*(C_star[1, 2:NZ]/qs[1, 2:NZ])**valence[ii]
      }
      
      
    } else {
      # monovalent isotherm
      sum_terms <- array(0.0, c(NZ))
      
      for (ii in 2:NZ) {
        sum_terms[ii] <- sum(q[NR, ,ii] / KxA) / CT_test[ii]
      }
      
      for (ii in 2:NION) {
        C_star[ii, 2:NZ] <- q[NR, ii, 2:NZ] / KxA[ii] / sum_terms[2:NZ]
      }
    }
    
    
    J <- array(0.0, c(NION, NZ))
    for (ii in 2:NION) {
      J[ii , 2:NZ] <- -kL[ii] * (C[ii , 2:NZ] - C_star[ii , 2:NZ])
    }
    # surface flux calculation
    J[1, 2:NZ] <- - colSums(J[2:NION, 2:NZ]) # Implicitly calculate reference ion
    
    Jas <- 3 / rb * J
    
    dx_dt[LIQUID, , 2:NZ] <- (- v / L * AZ_C[ ,2:NZ] + (1 - EBED) * Jas[ ,2:NZ]) / EBED * tc
    
    
    # internal diffusion (XXX: loops computationally slow)
    BR_q <- array(0.0, c(NR, NION, NZ))
    
    for (ii in 1:NION){
      for (jj in 2:NZ){
        BR_q[ , ii, jj] <- BR%*%q[ , ii, jj]
      }
    }
    
    dq_dt <- array(0.0, c(NR, NION, NZ))
    for (ii in 2:NION){
      dq_dt[ , ii, ] <- Ds[ii] * tc / rb**2 * BR_q[ , ii, ]
    }
    
    #  dq_dt[ , 1, 2:NZ] <- -rowSums(dq_dt[ , 2:NION, 2:NZ]) # Implicitly calculate reference ion
    # XXX: Why doesn't the above line work? It's not mathematically equivalent to the loop below?
    for (ii in 1:(NR-1)){
      dq_dt[ii, 1, 2:NZ] <- -colSums(dq_dt[ii, 2:NION, 2:NZ])
    }
    
    surf_term <- array(0.0, c(NION, NZ))
    for (ii in 1:NION){
      for (jj in 2:NZ){
        surf_term[ii, jj] <- WR[1:(NR-1)]%*%dq_dt[1:(NR-1), ii, jj]
      }
    }
    
    dx_dt[NR, , 2:NZ] <- (-tc / rb * J[ , 2:NZ] - surf_term[ , 2:NZ])/WR[NR]
    dx_dt[1:(NR-1), , 2:NZ] <- dq_dt[1:(NR-1), , 2:NZ]
    
    list(dx_dt) # return derivatives
  }
  
  # Integration ----
  out <- ode(y = x0, times = times, func = diffun, parms = NULL, method = "bdf")
  # XXX: is there something we can do with diagnose(out) ?
  
  t_out = out[ , 1]/60/60 # hours
  x_out = out[ , 2:(NEQ+1)]
  dim(x_out) <- c(nt_report, (NR+1), NION, NZ)
  
  # Check charge blances at outlet at end of simulation XXX: Maybe move inside of HSDMIX?
  stopifnot(all.equal(sum(x_out[nt_report, NR, , NZ]), Q))
  stopifnot(all.equal(sum(x_out[nt_report, (NR-1), , NZ]), Q))
  #stopifnot(all.equal(sum(x_out[nt_report, LIQUID, , NZ]), CT)) # XXX: TODO: tricky for timevarying infl.
  
  return(list(t_out, x_out)) # TODO: Name these and also provide success/fail info
}

#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#


#------------------------------------------------------------------------------#
                              #FUNCTION LIBRARY
#------------------------------------------------------------------------------#


#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
#------------------------------------------------------------------------------#
                              #process_files
# process_files is a function that reads in the input file, then splits each 
# page into 3 csv files and saves them separate. This may seem unnecessary at
# first, but the reason we do this is because the package DataEditR can only 
# read csv files and not xlsx files. We wanted to have a data frame that is as 
# easily editable as an excel page, and this is the only function that exists to
# do that
#------------------------------------------------------------------------------#

process_files <- function (file) {
  
  params<-read_xlsx(file, sheet="params")
  ions<-read_xlsx(file, sheet="ions")
  cin<-read_xlsx(file, sheet="Cin")
  
  
  write.csv(params, "paramsheet.csv", row.names=FALSE)
  write.csv(ions, "ionsheet.csv", row.names=FALSE)
  write.csv(cin, "cinsheet.csv", row.names=FALSE)
  
  
}


#------------------------------------------------------------------------------#
                              #Bed Volume
#------------------------------------------------------------------------------#

get_bv_in_sec <- function(input) {
  #get number of seconds per bv
  if (input$veloselect == 'Linear') {
    Vv = input$Vv*velocity_conv[input$VelocityUnits]
  } else {
    Vv = input$Fv * volumetric_conv[input$FlowrateUnits]/(pi/4 * ((input$Dv * length_conv[input$DiameterUnits])**2))
  }
  
  ## divide converted length by velocity to get BV in seconds
  return(input$Lv*length_conv[input$LengthUnits]/Vv)
  
}

#------------------------------------------------------------------------------#
                                  #HSDMIX Prep
#This function makes sure that the appropriate data frames are created
#and that they have the converted values 
#------------------------------------------------------------------------------#

HSDMIX_prep <- function (input, iondata, concdata, nt_report) {
  ## prepare paramdataframe for use by HSDMIX_solve
  if (input$veloselect == 'Linear') {
    Vv = input$Vv*velocity_conv[input$VelocityUnits]
  } else {
    Vv = input$Fv * volumetric_conv[input$FlowrateUnits]/(pi/4 * ((input$Dv * length_conv[input$DiameterUnits])**2))
  }
  
  paramdataframe <- data.frame(
    name=c("Q", "EBED", "L", "v", "rb", "kL", "Ds", "nr", "nz", "time"),
    value=c(input$Qv,
            input$EBEDv,
            input$Lv*length_conv[input$LengthUnits],
            Vv,
            input$rbv*length_conv[input$rbunits], NA, NA,
            input$nrv,
            input$nzv, 1),
    units=c("meq/L", NA, "cm", "cm/s", "cm", NA, NA, NA, NA, input$timeunits)
  )
  
  
  ## check that ions and concdata match
  error <- 0
  for (item in 1:nrow(iondata)) {
    ## checking ions are in concentration 
    if (!(iondata[item, 'name'] %in% colnames(concdata))) {
      print(paste0(iondata[item, 'name'], " not found in Concentration Data Columns"))
      error <- error + 1
    }
  }
  
  for (item in colnames(concdata)) {
    ## checking concentration ions in ion list
    if (item != "time") {
      if (!(item %in% iondata[, 'name'])) {
        print(paste0(item, " not found in Ion Data"))
        error <- error + 1
      }
    }
  } 
  
  print(paste0("Number of errors: ", error))
  
  ## replicate inputs, will change in next section
  corr_ions <- iondata
  corr_cin <- concdata
  
  
  ## we now know that compounds are in both lists, assuming error == 0
  if (error == 0) {
    for (item in 1:nrow(iondata)) {
      ## convert mass units
      mass_mult <- 1.
      mass_units <- iondata[item, "conc_units"]  # convenience variable
      if (mass_units != 'meq' && mass_units != 'meq/L') {
        mass_mult <- mass_conv[mass_units] / (iondata[item, "mw"]) * iondata[item, "valence"]  ## TODO: check this math
      }
      
      #should multiply a column by conversion factor
      compound <- iondata[item, "name"]  # convenience variable 
      # print(mass_mult )
      corr_cin[, compound] <- concdata[, compound] * mass_mult
      
      # print(paste0(iondata[item,"name"], " ", mass_mult))
      
      ### TODO: Need to check the mass transfer unit conversions
      ## convert kL to cm/s
      corr_ions[item, 'kL'] <- iondata[item, 'kL'] * kL_conv[iondata[item, 'kL_units']]
      
      ## convert Ds to cm/s^2
      corr_ions[item, 'Ds'] <- iondata[item, 'Ds'] * ds_conv[iondata[item, 'Ds_units']]
      
    }
  }
  
  ### test print Cin
  # print(concdata)
  # print(corr_cin)
  
  ### test print iondata
  # print(iondata)
  # print(corr_ions)
  
  #### test print input
  # print(input)
  
  timeconverter <- time_conv[input$timeunits2]  ### TODO: Is this really necessary, or doing what we think it is doing? 
  
  if (error == 0) {
    return (HSDMIX_solve(paramdataframe, corr_ions, corr_cin, timeconverter, nt_report))
  } else {
    return (error)
  }
}


#------------------------------------------------------------------------------#
                          #cc0 Conversion function
#------------------------------------------------------------------------------#


cc0_conv <- function (iondata, concdata) {
  error <- 0
  for (item in 1:nrow(iondata)) {
    ## checking ions are in concentration 
    if (!(iondata[item, 'name'] %in% colnames(concdata))) {
      print(paste0(iondata[item, 'name'], " not found in Concentration Data Columns"))
      error <- error + 1
    }
  }
  
  for (item in colnames(concdata)) {
    ## checking concentration ions in ion list
    if (item != "time") {
      if (!(item %in% iondata[, 'name'])) {
        print(paste0(item, " not found in Ion Data"))
        error <- error + 1
      }
    }
  } 
  if (error == 0) {
    cc0 <- c()
    meq_conv <- c()
    for (item in 1:nrow(iondata)) {
      if (iondata[item, "conc_units"] == "meq" || iondata[item, "conc_units"] == "meq/L") {
        meq_conv[iondata[item, "name"]] <- 1
      } else {
        meq_conv[iondata[item, "name"]] <- mass_conv[iondata[item, "conc_units"]] * iondata[item,"valence"] / iondata[item, "mw"]
      }
    }
    for (item in colnames(concdata)) {
      ## checking concentration ions in ion list
      if (item != "time") {
        cc0[item] <- concdata[1, item] * meq_conv[item]
      }
    }
    print(cc0)
    return(cc0)
  } else{
    returnc(concdata[2,2:ncol(concdata)])
  }
  
} 



#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#





#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#


wd <- getwd()
process_files(paste0("config.xlsx"))


#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
#------------------------------------------------------------------------------#
#BEGIN UI#
# The UI section deals with all the visuals that the user will interact with
# This section is split up into 3 tabs, Input, Output, and About
# The Input section has 2 tabs, parameters and ions, these have default values
# So that the code can be ran without inputting anything, but the user can upload
# an excel file that will overwrite this data, and the user can edit it further
# within these tabs
# The Output section displays the plots where the x and y-axis can be converted
# into other units
# The about section contains information about the tool for further details
# The side bar panel which is present throughout the app is used for minor 
# adjustments as well as the axis conversions and file inputs
#------------------------------------------------------------------------------#

ui <- fluidPage(
  
  useShinyjs(),
  
  tags$html(class = "no-js", lang="en"),
  tags$head(
    tags$link(rel="stylesheet", media="all", href="https://www.epa.gov/themes/epa_theme/css/styles.css?r6lsex")),
  
  # Site Header
  
  HTML(
    '
    <div>
      <div class="js-view-dom-id-epa-alerts--public">
        <noscript>
          <div class="usa-site-alert usa-site-alert--info">
            <div class="usa-alert">
              <div class="usa-alert__body">
                <div class="usa-alert__text">
                  <p>JavaScript appears to be disabled on this computer. Please <a href="/alerts">click here to see any active alerts</a>.</p>
                </div>
              </div>
            </div>
          </div>
        </noscript>
      </div>
    </div>
    <header class="l-header">
      <div class="usa-overlay"></div>
      <div class="l-constrain">
        <div class="l-header__navbar">
          <div class="l-header__branding">
            <a class="site-logo" href="/" aria-label="Home" title="Home" rel="home">
              <span class="site-logo__image">
                <svg class="site-logo__svg" viewBox="0 0 1061 147" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                  <path d="M112.8 53.5C108 72.1 89.9 86.8 69.9 86.8c-20.1 0-38-14.7-42.9-33.4h.2s9.8 10.3-.2 0c3.1 3.1 6.2 4.4 10.7 4.4s7.7-1.3 10.7-4.4c3.1 3.1 6.3 4.5 10.9 4.4 4.5 0 7.6-1.3 10.7-4.4 3.1 3.1 6.2 4.4 10.7 4.4 4.5 0 7.7-1.3 10.7-4.4 3.1 3.1 6.3 4.5 10.9 4.4 4.3 0 7.4-1.2 10.5-4.3zM113.2 43.5c0-24-19.4-43.5-43.3-43.5-24 0-43.5 19.5-43.5 43.5h39.1c-4.8-1.8-8.1-6.3-8.1-11.6 0-7 5.7-12.5 12.5-12.5 7 0 12.7 5.5 12.7 12.5 0 5.2-3.1 9.6-7.6 11.6h38.2zM72.6 139.3c.7-36.9 29.7-68.8 66.9-70 0 37.2-30 68-66.9 70zM67.1 139.3c-.7-36.9-29.7-68.8-67.1-70 0 37.2 30.2 68 67.1 70zM240 3.1h-87.9v133.1H240v-20.4h-60.3v-36H240v-21h-60.3v-35H240V3.1zM272.8 58.8h27.1c9.1 0 15.2-8.6 15.1-17.7-.1-9-6.1-17.3-15.1-17.3h-25.3v112.4h-27.8V3.1h62.3c20.2 0 35 17.8 35.2 38 .2 20.4-14.8 38.7-35.2 38.7h-36.3v-21zM315.9 136.2h29.7l12.9-35h54.2l-8.1-21.9h-38.4l18.9-50.7 39.2 107.6H454L400.9 3.1h-33.7l-51.3 133.1zM473.3.8v22.4c0 1.9.2 3.3.5 4.3s.7 1.7 1 2.2c1.2 1.4 2.5 2.4 3.9 2.9 1.5.5 2.8.7 4.1.7 2.4 0 4.2-.4 5.5-1.3 1.3-.8 2.2-1.8 2.8-2.9.6-1.1.9-2.3 1-3.4.1-1.1.1-2 .1-2.6V.8h4.7v24c0 .7-.1 1.5-.4 2.4-.3 1.8-1.2 3.6-2.5 5.4-1.8 2.1-3.8 3.5-6 4.2-2.2.6-4 .9-5.3.9-1.8 0-3.8-.3-6.2-1.1-2.4-.8-4.5-2.3-6.2-4.7-.5-.8-1-1.8-1.4-3.2-.4-1.3-.6-3.3-.6-5.9V.8h5zM507.5 14.5v-2.9l4.6.1-.1 4.1c.2-.3.4-.7.8-1.2.3-.5.8-.9 1.4-1.4.6-.5 1.4-.9 2.3-1.3.9-.3 2.1-.5 3.4-.4.6 0 1.4.1 2.4.3.9.2 1.9.6 2.9 1.2s1.8 1.5 2.4 2.6c.6 1.2.9 2.8.9 4.7l-.4 17-4.6-.1.4-16c0-.9 0-1.7-.2-2.4-.1-.7-.5-1.3-1.1-1.9-1.2-1.2-2.6-1.8-4.3-1.8-1.7 0-3.1.5-4.4 1.7-1.3 1.2-2 3.1-2.1 5.7l-.3 14.5-4.5-.1.5-22.4zM537.2.9h5.5V6h-5.5V.9m.5 10.9h4.6v25.1h-4.6V11.8zM547.8 11.7h4.3V6.4l4.5-1.5v6.8h5.4v3.4h-5.4v15.1c0 .3 0 .6.1 1 0 .4.1.7.4 1.1.2.4.5.6 1 .8.4.3 1 .4 1.8.4 1 0 1.7-.1 2.2-.2V37c-.9.2-2.1.3-3.8.3-2.1 0-3.6-.4-4.6-1.2-1-.8-1.5-2.2-1.5-4.2V15.1h-4.3v-3.4zM570.9 25.2c-.1 2.6.5 4.8 1.7 6.5 1.1 1.7 2.9 2.6 5.3 2.6 1.5 0 2.8-.4 3.9-1.3 1-.8 1.6-2.2 1.8-4h4.6c0 .6-.2 1.4-.4 2.3-.3 1-.8 2-1.7 3-.2.3-.6.6-1 1-.5.4-1 .7-1.7 1.1-.7.4-1.5.6-2.4.8-.9.3-2 .4-3.3.4-7.6-.2-11.3-4.5-11.3-12.9 0-2.5.3-4.8 1-6.8s2-3.7 3.8-5.1c1.2-.8 2.4-1.3 3.7-1.6 1.3-.2 2.2-.3 3-.3 2.7 0 4.8.6 6.3 1.6s2.5 2.3 3.1 3.9c.6 1.5 1 3.1 1.1 4.6.1 1.6.1 2.9 0 4h-17.5m12.9-3v-1.1c0-.4 0-.8-.1-1.2-.1-.9-.4-1.7-.8-2.5s-1-1.5-1.8-2c-.9-.5-2-.8-3.4-.8-.8 0-1.5.1-2.3.3-.8.2-1.5.7-2.2 1.3-.7.6-1.2 1.3-1.6 2.3-.4 1-.7 2.2-.8 3.6h13zM612.9.9h4.6V33c0 1 .1 2.3.2 4h-4.6l-.1-4c-.2.3-.4.7-.7 1.2-.3.5-.8 1-1.4 1.5-1 .7-2 1.2-3.1 1.4l-1.5.3c-.5.1-.9.1-1.4.1-.4 0-.8 0-1.3-.1s-1.1-.2-1.7-.3c-1.1-.3-2.3-.9-3.4-1.8s-2.1-2.2-2.9-3.8c-.8-1.7-1.2-3.9-1.2-6.6.1-4.8 1.2-8.3 3.4-10.5 2.1-2.1 4.7-3.2 7.6-3.2 1.3 0 2.4.2 3.4.5.9.3 1.6.7 2.2 1.2.6.4 1 .9 1.3 1.4.3.5.6.8.7 1.1V.9m0 23.1c0-1.9-.2-3.3-.5-4.4-.4-1.1-.8-2-1.4-2.6-.5-.7-1.2-1.3-2-1.8-.9-.5-2-.7-3.3-.7-1.7 0-2.9.5-3.8 1.3-.9.8-1.6 1.9-2 3.1-.4 1.2-.7 2.3-.7 3.4-.1 1.1-.2 1.9-.1 2.4 0 1.1.1 2.2.3 3.4.2 1.1.5 2.2 1 3.1.5 1 1.2 1.7 2 2.3.9.6 2 .9 3.3.9 1.8 0 3.2-.5 4.2-1.4 1-.8 1.7-1.8 2.1-3 .4-1.2.7-2.4.8-3.4.1-1.4.1-2.1.1-2.6zM643.9 26.4c0 .6.1 1.3.3 2.1.1.8.5 1.6 1 2.3.5.8 1.4 1.4 2.5 1.9s2.7.8 4.7.8c1.8 0 3.3-.3 4.4-.8 1.1-.5 1.9-1.1 2.5-1.8.6-.7 1-1.5 1.1-2.2.1-.7.2-1.2.2-1.7 0-1-.2-1.9-.5-2.6-.4-.6-.9-1.2-1.6-1.6-1.4-.8-3.4-1.4-5.9-2-4.9-1.1-8.1-2.2-9.5-3.2-1.4-1-2.3-2.2-2.9-3.5-.6-1.2-.8-2.4-.8-3.6.1-3.7 1.5-6.4 4.2-8.1 2.6-1.7 5.7-2.5 9.1-2.5 1.3 0 2.9.2 4.8.5 1.9.4 3.6 1.4 5 3 .5.5.9 1.1 1.2 1.7.3.5.5 1.1.6 1.6.2 1.1.3 2.1.3 2.9h-5c-.2-2.2-1-3.7-2.4-4.5-1.5-.7-3.1-1.1-4.9-1.1-5.1.1-7.7 2-7.8 5.8 0 1.5.5 2.7 1.6 3.5 1 .8 2.6 1.4 4.7 1.9 4 1 6.7 1.8 8.1 2.2.8.2 1.4.5 1.8.7.5.2 1 .5 1.4.9.8.5 1.4 1.1 1.9 1.8s.8 1.4 1.1 2.1c.3 1.4.5 2.5.5 3.4 0 3.3-1.2 6-3.5 8-2.3 2.1-5.8 3.2-10.3 3.3-1.4 0-3.2-.3-5.4-.8-1-.3-2-.7-3-1.2-.9-.5-1.8-1.2-2.5-2.1-.9-1.4-1.5-2.7-1.7-4.1-.3-1.3-.4-2.4-.3-3.2h5zM670 11.7h4.3V6.4l4.5-1.5v6.8h5.4v3.4h-5.4v15.1c0 .3 0 .6.1 1 0 .4.1.7.4 1.1.2.4.5.6 1 .8.4.3 1 .4 1.8.4 1 0 1.7-.1 2.2-.2V37c-.9.2-2.1.3-3.8.3-2.1 0-3.6-.4-4.6-1.2-1-.8-1.5-2.2-1.5-4.2V15.1H670v-3.4zM705.3 36.9c-.3-1.2-.5-2.5-.4-3.7-.5 1-1.1 1.8-1.7 2.4-.7.6-1.4 1.1-2 1.4-1.4.5-2.7.8-3.7.8-2.8 0-4.9-.8-6.4-2.2-1.5-1.4-2.2-3.1-2.2-5.2 0-1 .2-2.3.8-3.7.6-1.4 1.7-2.6 3.5-3.7 1.4-.7 2.9-1.2 4.5-1.5 1.6-.1 2.9-.2 3.9-.2s2.1 0 3.3.1c.1-2.9-.2-4.8-.9-5.6-.5-.6-1.1-1.1-1.9-1.3-.8-.2-1.6-.4-2.3-.4-1.1 0-2 .2-2.6.5-.7.3-1.2.7-1.5 1.2-.3.5-.5.9-.6 1.4-.1.5-.2.9-.2 1.2h-4.6c.1-.7.2-1.4.4-2.3.2-.8.6-1.6 1.3-2.5.5-.6 1-1 1.7-1.3.6-.3 1.3-.6 2-.8 1.5-.4 2.8-.6 4.2-.6 1.8 0 3.6.3 5.2.9 1.6.6 2.8 1.6 3.4 2.9.4.7.6 1.4.7 2 .1.6.1 1.2.1 1.8l-.2 12c0 1 .1 3.1.4 6.3h-4.2m-.5-12.1c-.7-.1-1.6-.1-2.6-.1h-2.1c-1 .1-2 .3-3 .6s-1.9.8-2.6 1.5c-.8.7-1.2 1.7-1.2 3 0 .4.1.8.2 1.3s.4 1 .8 1.5.9.8 1.6 1.1c.7.3 1.5.5 2.5.5 2.3 0 4.1-.9 5.2-2.7.5-.8.8-1.7 1-2.7.1-.9.2-2.2.2-4zM714.5 11.7h4.3V6.4l4.5-1.5v6.8h5.4v3.4h-5.4v15.1c0 .3 0 .6.1 1 0 .4.1.7.4 1.1.2.4.5.6 1 .8.4.3 1 .4 1.8.4 1 0 1.7-.1 2.2-.2V37c-.9.2-2.1.3-3.8.3-2.1 0-3.6-.4-4.6-1.2-1-.8-1.5-2.2-1.5-4.2V15.1h-4.3v-3.4zM737.6 25.2c-.1 2.6.5 4.8 1.7 6.5 1.1 1.7 2.9 2.6 5.3 2.6 1.5 0 2.8-.4 3.9-1.3 1-.8 1.6-2.2 1.8-4h4.6c0 .6-.2 1.4-.4 2.3-.3 1-.8 2-1.7 3-.2.3-.6.6-1 1-.5.4-1 .7-1.7 1.1-.7.4-1.5.6-2.4.8-.9.3-2 .4-3.3.4-7.6-.2-11.3-4.5-11.3-12.9 0-2.5.3-4.8 1-6.8s2-3.7 3.8-5.1c1.2-.8 2.4-1.3 3.7-1.6 1.3-.2 2.2-.3 3-.3 2.7 0 4.8.6 6.3 1.6s2.5 2.3 3.1 3.9c.6 1.5 1 3.1 1.1 4.6.1 1.6.1 2.9 0 4h-17.5m12.9-3v-1.1c0-.4 0-.8-.1-1.2-.1-.9-.4-1.7-.8-2.5s-1-1.5-1.8-2c-.9-.5-2-.8-3.4-.8-.8 0-1.5.1-2.3.3-.8.2-1.5.7-2.2 1.3-.7.6-1.2 1.3-1.6 2.3-.4 1-.7 2.2-.8 3.6h13zM765.3 29.5c0 .5.1 1 .2 1.4.1.5.4 1 .8 1.5s.9.8 1.6 1.1c.7.3 1.6.5 2.7.5 1 0 1.8-.1 2.5-.3.7-.2 1.3-.6 1.7-1.2.5-.7.8-1.5.8-2.4 0-1.2-.4-2-1.3-2.5s-2.2-.9-4.1-1.2c-1.3-.3-2.4-.6-3.6-1-1.1-.3-2.1-.8-3-1.3-.9-.5-1.5-1.2-2-2.1-.5-.8-.8-1.9-.8-3.2 0-2.4.9-4.2 2.6-5.6 1.7-1.3 4-2 6.8-2.1 1.6 0 3.3.3 5 .8 1.7.6 2.9 1.6 3.7 3.1.4 1.4.6 2.6.6 3.7h-4.6c0-1.8-.6-3-1.7-3.5-1.1-.4-2.1-.6-3.1-.6h-1c-.5 0-1.1.2-1.7.4-.6.2-1.1.5-1.5 1.1-.5.5-.7 1.2-.7 2.1 0 1.1.5 1.9 1.3 2.3.7.4 1.5.7 2.1.9 3.3.7 5.6 1.3 6.9 1.8 1.3.4 2.2 1 2.8 1.7.7.7 1.1 1.4 1.4 2.2.3.8.4 1.6.4 2.5 0 1.4-.3 2.7-.9 3.8-.6 1.1-1.4 2-2.4 2.6-1.1.6-2.2 1-3.4 1.3-1.2.3-2.5.4-3.8.4-2.5 0-4.7-.6-6.6-1.8-1.8-1.2-2.8-3.3-2.9-6.3h5.2zM467.7 50.8h21.9V55h-17.1v11.3h16.3v4.2h-16.3v12.1H490v4.3h-22.3zM499 64.7l-.1-2.9h4.6v4.1c.2-.3.4-.8.7-1.2.3-.5.8-1 1.3-1.5.6-.5 1.4-1 2.3-1.3.9-.3 2-.5 3.4-.5.6 0 1.4.1 2.4.2.9.2 1.9.5 2.9 1.1 1 .6 1.8 1.4 2.5 2.5.6 1.2 1 2.7 1 4.7V87h-4.6V71c0-.9-.1-1.7-.2-2.4-.2-.7-.5-1.3-1.1-1.9-1.2-1.1-2.6-1.7-4.3-1.7-1.7 0-3.1.6-4.3 1.8-1.3 1.2-2 3.1-2 5.7V87H499V64.7zM524.6 61.8h5.1l7.7 19.9 7.6-19.9h5l-10.6 25.1h-4.6zM555.7 50.9h5.5V56h-5.5v-5.1m.5 10.9h4.6v25.1h-4.6V61.8zM570.3 67c0-1.8-.1-3.5-.3-5.1h4.6l.1 4.9c.5-1.8 1.4-3 2.5-3.7 1.1-.7 2.2-1.2 3.3-1.3 1.4-.2 2.4-.2 3.1-.1v4.6c-.2-.1-.5-.2-.9-.2h-1.3c-1.3 0-2.4.2-3.3.5-.9.4-1.5.9-2 1.6-.9 1.4-1.4 3.2-1.3 5.4v13.3h-4.6V67zM587.6 74.7c0-1.6.2-3.2.6-4.8.4-1.6 1.1-3 2-4.4 1-1.3 2.2-2.4 3.8-3.2 1.6-.8 3.6-1.2 5.9-1.2 2.4 0 4.5.4 6.1 1.3 1.5.9 2.7 2 3.6 3.3.9 1.3 1.5 2.8 1.8 4.3.2.8.3 1.5.4 2.2v2.2c0 3.7-1 6.9-3 9.5-2 2.6-5.1 4-9.3 4-4-.1-7-1.4-9-3.9-1.9-2.5-2.9-5.6-2.9-9.3m4.8-.3c0 2.7.6 5 1.8 6.9 1.2 2 3 3 5.6 3.1.9 0 1.8-.2 2.7-.5.8-.3 1.6-.9 2.3-1.7.7-.8 1.3-1.9 1.8-3.2.4-1.3.6-2.9.6-4.7-.1-6.4-2.5-9.6-7.1-9.6-.7 0-1.5.1-2.4.3-.8.3-1.7.8-2.5 1.6-.8.7-1.4 1.7-1.9 3-.6 1.1-.9 2.8-.9 4.8zM620.2 64.7l-.1-2.9h4.6v4.1c.2-.3.4-.8.7-1.2.3-.5.8-1 1.3-1.5.6-.5 1.4-1 2.3-1.3.9-.3 2-.5 3.4-.5.6 0 1.4.1 2.4.2.9.2 1.9.5 2.9 1.1 1 .6 1.8 1.4 2.5 2.5.6 1.2 1 2.7 1 4.7V87h-4.6V71c0-.9-.1-1.7-.2-2.4-.2-.7-.5-1.3-1.1-1.9-1.2-1.1-2.6-1.7-4.3-1.7-1.7 0-3.1.6-4.3 1.8-1.3 1.2-2 3.1-2 5.7V87h-4.6V64.7zM650 65.1l-.1-3.3h4.6v3.6c1.2-1.9 2.6-3.2 4.1-3.7 1.5-.4 2.7-.6 3.8-.6 1.4 0 2.6.2 3.6.5.9.3 1.7.7 2.3 1.1 1.1 1 1.9 2 2.3 3.1.2-.4.5-.8 1-1.3.4-.5.9-1 1.5-1.6.6-.5 1.5-.9 2.5-1.3 1-.3 2.2-.5 3.5-.5.9 0 1.9.1 3 .3 1 .2 2 .7 3 1.3 1 .6 1.7 1.5 2.3 2.7.6 1.2.9 2.7.9 4.6v16.9h-4.6V70.7c0-1.1-.1-2-.2-2.5-.1-.6-.3-1-.6-1.3-.4-.6-1-1.2-1.8-1.6-.8-.4-1.8-.6-3.1-.6-1.5 0-2.7.4-3.6 1-.4.3-.8.5-1.1.9l-.8.8c-.5.8-.8 1.8-1 2.8-.1 1.1-.2 2-.1 2.6v14.1h-4.6V70.2c0-1.6-.5-2.9-1.4-4-.9-1-2.3-1.5-4.2-1.5-1.6 0-2.9.4-3.8 1.1-.9.7-1.5 1.2-1.8 1.7-.5.7-.8 1.5-.9 2.5-.1.9-.2 1.8-.2 2.6v14.3H650V65.1zM700.5 75.2c-.1 2.6.5 4.8 1.7 6.5 1.1 1.7 2.9 2.6 5.3 2.6 1.5 0 2.8-.4 3.9-1.3 1-.8 1.6-2.2 1.8-4h4.6c0 .6-.2 1.4-.4 2.3-.3 1-.8 2-1.7 3-.2.3-.6.6-1 1-.5.4-1 .7-1.7 1.1-.7.4-1.5.6-2.4.8-.9.3-2 .4-3.3.4-7.6-.2-11.3-4.5-11.3-12.9 0-2.5.3-4.8 1-6.8s2-3.7 3.8-5.1c1.2-.8 2.4-1.3 3.7-1.6 1.3-.2 2.2-.3 3-.3 2.7 0 4.8.6 6.3 1.6s2.5 2.3 3.1 3.9c.6 1.5 1 3.1 1.1 4.6.1 1.6.1 2.9 0 4h-17.5m12.8-3v-1.1c0-.4 0-.8-.1-1.2-.1-.9-.4-1.7-.8-2.5s-1-1.5-1.8-2c-.9-.5-2-.8-3.4-.8-.8 0-1.5.1-2.3.3-.8.2-1.5.7-2.2 1.3-.7.6-1.2 1.3-1.6 2.3-.4 1-.7 2.2-.8 3.6h13zM725.7 64.7l-.1-2.9h4.6v4.1c.2-.3.4-.8.7-1.2.3-.5.8-1 1.3-1.5.6-.5 1.4-1 2.3-1.3.9-.3 2-.5 3.4-.5.6 0 1.4.1 2.4.2.9.2 1.9.5 2.9 1.1 1 .6 1.8 1.4 2.5 2.5.6 1.2 1 2.7 1 4.7V87h-4.6V71c0-.9-.1-1.7-.2-2.4-.2-.7-.5-1.3-1.1-1.9-1.2-1.1-2.6-1.7-4.3-1.7-1.7 0-3.1.6-4.3 1.8-1.3 1.2-2 3.1-2 5.7V87h-4.6V64.7zM752.3 61.7h4.3v-5.2l4.5-1.5v6.8h5.4v3.4h-5.4v15.1c0 .3 0 .6.1 1 0 .4.1.7.4 1.1.2.4.5.6 1 .8.4.3 1 .4 1.8.4 1 0 1.7-.1 2.2-.2V87c-.9.2-2.1.3-3.8.3-2.1 0-3.6-.4-4.6-1.2-1-.8-1.5-2.2-1.5-4.2V65.1h-4.3v-3.4zM787.6 86.9c-.3-1.2-.5-2.5-.4-3.7-.5 1-1.1 1.8-1.7 2.4-.7.6-1.4 1.1-2 1.4-1.4.5-2.7.8-3.7.8-2.8 0-4.9-.8-6.4-2.2-1.5-1.4-2.2-3.1-2.2-5.2 0-1 .2-2.3.8-3.7.6-1.4 1.7-2.6 3.5-3.7 1.4-.7 2.9-1.2 4.5-1.5 1.6-.1 2.9-.2 3.9-.2s2.1 0 3.3.1c.1-2.9-.2-4.8-.9-5.6-.5-.6-1.1-1.1-1.9-1.3-.8-.2-1.6-.4-2.3-.4-1.1 0-2 .2-2.6.5-.7.3-1.2.7-1.5 1.2-.3.5-.5.9-.6 1.4-.1.5-.2.9-.2 1.2h-4.6c.1-.7.2-1.4.4-2.3.2-.8.6-1.6 1.3-2.5.5-.6 1-1 1.7-1.3.6-.3 1.3-.6 2-.8 1.5-.4 2.8-.6 4.2-.6 1.8 0 3.6.3 5.2.9 1.6.6 2.8 1.6 3.4 2.9.4.7.6 1.4.7 2 .1.6.1 1.2.1 1.8l-.2 12c0 1 .1 3.1.4 6.3h-4.2m-.5-12.1c-.7-.1-1.6-.1-2.6-.1h-2.1c-1 .1-2 .3-3 .6s-1.9.8-2.6 1.5c-.8.7-1.2 1.7-1.2 3 0 .4.1.8.2 1.3s.4 1 .8 1.5.9.8 1.6 1.1c.7.3 1.5.5 2.5.5 2.3 0 4.1-.9 5.2-2.7.5-.8.8-1.7 1-2.7.1-.9.2-2.2.2-4zM800.7 50.9h4.6V87h-4.6zM828.4 50.8h11.7c2.1 0 3.9.1 5.5.4.8.2 1.5.4 2.2.9.7.4 1.3.9 1.8 1.6 1.7 1.9 2.6 4.2 2.6 7 0 2.7-.9 5.1-2.8 7.1-.8.9-2 1.7-3.6 2.2-1.6.6-3.9.9-6.9.9h-5.7V87h-4.8V50.8m4.8 15.9h5.8c.8 0 1.7-.1 2.6-.2.9-.1 1.8-.3 2.6-.7.8-.4 1.5-1 2-1.9.5-.8.8-2 .8-3.4s-.2-2.5-.7-3.3c-.5-.8-1.1-1.3-1.9-1.7-1.6-.5-3.1-.8-4.5-.7h-6.8v11.9zM858.1 67c0-1.8-.1-3.5-.3-5.1h4.6l.1 4.9c.5-1.8 1.4-3 2.5-3.7 1.1-.7 2.2-1.2 3.3-1.3 1.4-.2 2.4-.2 3.1-.1v4.6c-.2-.1-.5-.2-.9-.2h-1.3c-1.3 0-2.4.2-3.3.5-.9.4-1.5.9-2 1.6-.9 1.4-1.4 3.2-1.3 5.4v13.3H858V67zM875.5 74.7c0-1.6.2-3.2.6-4.8.4-1.6 1.1-3 2-4.4 1-1.3 2.2-2.4 3.8-3.2 1.6-.8 3.6-1.2 5.9-1.2 2.4 0 4.5.4 6.1 1.3 1.5.9 2.7 2 3.6 3.3.9 1.3 1.5 2.8 1.8 4.3.2.8.3 1.5.4 2.2v2.2c0 3.7-1 6.9-3 9.5-2 2.6-5.1 4-9.3 4-4-.1-7-1.4-9-3.9-1.9-2.5-2.9-5.6-2.9-9.3m4.8-.3c0 2.7.6 5 1.8 6.9 1.2 2 3 3 5.6 3.1.9 0 1.8-.2 2.7-.5.8-.3 1.6-.9 2.3-1.7.7-.8 1.3-1.9 1.8-3.2.4-1.3.6-2.9.6-4.7-.1-6.4-2.5-9.6-7.1-9.6-.7 0-1.5.1-2.4.3-.8.3-1.7.8-2.5 1.6-.8.7-1.4 1.7-1.9 3-.7 1.1-.9 2.8-.9 4.8zM904.1 61.7h4.3v-5.2l4.5-1.5v6.8h5.4v3.4h-5.4v15.1c0 .3 0 .6.1 1 0 .4.1.7.4 1.1.2.4.5.6 1 .8.4.3 1 .4 1.8.4 1 0 1.7-.1 2.2-.2V87c-.9.2-2.1.3-3.8.3-2.1 0-3.6-.4-4.6-1.2-1-.8-1.5-2.2-1.5-4.2V65.1h-4.3v-3.4zM927.2 75.2c-.1 2.6.5 4.8 1.7 6.5 1.1 1.7 2.9 2.6 5.3 2.6 1.5 0 2.8-.4 3.9-1.3 1-.8 1.6-2.2 1.8-4h4.6c0 .6-.2 1.4-.4 2.3-.3 1-.8 2-1.7 3-.2.3-.6.6-1 1-.5.4-1 .7-1.7 1.1-.7.4-1.5.6-2.4.8-.9.3-2 .4-3.3.4-7.6-.2-11.3-4.5-11.3-12.9 0-2.5.3-4.8 1-6.8s2-3.7 3.8-5.1c1.2-.8 2.4-1.3 3.7-1.6 1.3-.2 2.2-.3 3-.3 2.7 0 4.8.6 6.3 1.6s2.5 2.3 3.1 3.9c.6 1.5 1 3.1 1.1 4.6.1 1.6.1 2.9 0 4h-17.5m12.9-3v-1.1c0-.4 0-.8-.1-1.2-.1-.9-.4-1.7-.8-2.5s-1-1.5-1.8-2c-.9-.5-2-.8-3.4-.8-.8 0-1.5.1-2.3.3-.8.2-1.5.7-2.2 1.3-.7.6-1.2 1.3-1.6 2.3-.4 1-.7 2.2-.8 3.6h13zM966.1 69.8c0-.3 0-.8-.1-1.4-.1-.6-.3-1.1-.6-1.8-.2-.6-.7-1.2-1.4-1.6-.7-.4-1.6-.6-2.7-.6-1.5 0-2.7.4-3.5 1.2-.9.8-1.5 1.7-1.9 2.8-.4 1.1-.6 2.2-.7 3.2-.1 1.1-.2 1.8-.1 2.4 0 1.3.1 2.5.3 3.7.2 1.2.5 2.3.9 3.3.8 2 2.4 3 4.8 3.1 1.9 0 3.3-.7 4.1-1.9.8-1.1 1.2-2.3 1.2-3.6h4.6c-.2 2.5-1.1 4.6-2.7 6.3-1.7 1.8-4.1 2.7-7.1 2.7-.9 0-2.1-.2-3.6-.6-.7-.2-1.4-.6-2.2-1-.8-.4-1.5-1-2.2-1.7-.7-.9-1.4-2.1-2-3.6-.6-1.5-.9-3.5-.9-6.1 0-2.6.4-4.8 1.1-6.6.7-1.7 1.6-3.1 2.7-4.2 1.1-1 2.3-1.8 3.6-2.2 1.3-.4 2.5-.6 3.7-.6h1.6c.6.1 1.3.2 1.9.4.7.2 1.4.5 2.1 1 .7.4 1.3 1 1.8 1.7.9 1.1 1.4 2.1 1.7 3.1.2 1 .3 1.8.3 2.6h-4.7zM973.6 61.7h4.3v-5.2l4.5-1.5v6.8h5.4v3.4h-5.4v15.1c0 .3 0 .6.1 1 0 .4.1.7.4 1.1.2.4.5.6 1 .8.4.3 1 .4 1.8.4 1 0 1.7-.1 2.2-.2V87c-.9.2-2.1.3-3.8.3-2.1 0-3.6-.4-4.6-1.2-1-.8-1.5-2.2-1.5-4.2V65.1h-4.3v-3.4zM993.5 50.9h5.5V56h-5.5v-5.1m.5 10.9h4.6v25.1H994V61.8zM1006.1 74.7c0-1.6.2-3.2.6-4.8.4-1.6 1.1-3 2-4.4 1-1.3 2.2-2.4 3.8-3.2 1.6-.8 3.6-1.2 5.9-1.2 2.4 0 4.5.4 6.1 1.3 1.5.9 2.7 2 3.6 3.3.9 1.3 1.5 2.8 1.8 4.3.2.8.3 1.5.4 2.2v2.2c0 3.7-1 6.9-3 9.5-2 2.6-5.1 4-9.3 4-4-.1-7-1.4-9-3.9-1.9-2.5-2.9-5.6-2.9-9.3m4.7-.3c0 2.7.6 5 1.8 6.9 1.2 2 3 3 5.6 3.1.9 0 1.8-.2 2.7-.5.8-.3 1.6-.9 2.3-1.7.7-.8 1.3-1.9 1.8-3.2.4-1.3.6-2.9.6-4.7-.1-6.4-2.5-9.6-7.1-9.6-.7 0-1.5.1-2.4.3-.8.3-1.7.8-2.5 1.6-.8.7-1.4 1.7-1.9 3-.6 1.1-.9 2.8-.9 4.8zM1038.6 64.7l-.1-2.9h4.6v4.1c.2-.3.4-.8.7-1.2.3-.5.8-1 1.3-1.5.6-.5 1.4-1 2.3-1.3.9-.3 2-.5 3.4-.5.6 0 1.4.1 2.4.2.9.2 1.9.5 2.9 1.1 1 .6 1.8 1.4 2.5 2.5.6 1.2 1 2.7 1 4.7V87h-4.6V71c0-.9-.1-1.7-.2-2.4-.2-.7-.5-1.3-1.1-1.9-1.2-1.1-2.6-1.7-4.3-1.7-1.7 0-3.1.6-4.3 1.8-1.3 1.2-2 3.1-2 5.7V87h-4.6V64.7zM479.1 100.8h5.2l14.1 36.1h-5.3l-3.8-9.4h-16.2l-3.8 9.4h-5l14.8-36.1m-4.4 22.7H488l-6.5-17.8-6.8 17.8zM508.7 138.8c.1.7.2 1.4.4 1.9.2.6.5 1.1.9 1.6.8.9 2.3 1.4 4.4 1.5 1.6 0 2.8-.3 3.7-.9.9-.6 1.5-1.4 1.9-2.4.4-1.1.6-2.3.7-3.7.1-1.4.1-2.9.1-4.6-.5.9-1.1 1.7-1.8 2.3-.7.6-1.5 1-2.3 1.3-1.7.4-3 .6-3.9.6-1.2 0-2.4-.2-3.8-.6-1.4-.4-2.6-1.2-3.7-2.5-1-1.3-1.7-2.8-2.1-4.4-.4-1.6-.6-3.2-.6-4.8 0-4.3 1.1-7.4 3.2-9.5 2-2.1 4.6-3.1 7.6-3.1 1.3 0 2.3.1 3.2.4.9.3 1.6.6 2.1 1 .6.4 1.1.8 1.5 1.2l.9 1.2v-3.4h4.4l-.1 4.5v15.7c0 2.9-.1 5.2-.2 6.7-.2 1.6-.5 2.8-1 3.7-1.1 1.9-2.6 3.2-4.6 3.7-1.9.6-3.8.8-5.6.8-2.4 0-4.3-.3-5.6-.8-1.4-.5-2.4-1.2-3-2-.6-.8-1-1.7-1.2-2.7-.2-.9-.3-1.8-.4-2.7h4.9m5.3-5.8c1.4 0 2.5-.2 3.3-.7.8-.5 1.5-1.1 2-1.8.5-.6.9-1.4 1.2-2.5.3-1 .4-2.6.4-4.8 0-1.6-.2-2.9-.4-3.9-.3-1-.8-1.8-1.4-2.4-1.3-1.4-3-2.2-5.2-2.2-1.4 0-2.5.3-3.4 1-.9.7-1.6 1.5-2 2.4-.4 1-.7 2-.9 3-.2 1-.2 2-.2 2.8 0 1 .1 1.9.3 2.9.2 1.1.5 2.1 1 3 .5.9 1.2 1.6 2 2.2.8.7 1.9 1 3.3 1zM537.6 125.2c-.1 2.6.5 4.8 1.7 6.5 1.1 1.7 2.9 2.6 5.3 2.6 1.5 0 2.8-.4 3.9-1.3 1-.8 1.6-2.2 1.8-4h4.6c0 .6-.2 1.4-.4 2.3-.3 1-.8 2-1.7 3-.2.3-.6.6-1 1-.5.4-1 .7-1.7 1.1-.7.4-1.5.6-2.4.8-.9.3-2 .4-3.3.4-7.6-.2-11.3-4.5-11.3-12.9 0-2.5.3-4.8 1-6.8s2-3.7 3.8-5.1c1.2-.8 2.4-1.3 3.7-1.6 1.3-.2 2.2-.3 3-.3 2.7 0 4.8.6 6.3 1.6s2.5 2.3 3.1 3.9c.6 1.5 1 3.1 1.1 4.6.1 1.6.1 2.9 0 4h-17.5m12.9-3v-1.1c0-.4 0-.8-.1-1.2-.1-.9-.4-1.7-.8-2.5s-1-1.5-1.8-2.1c-.9-.5-2-.8-3.4-.8-.8 0-1.5.1-2.3.3-.8.2-1.5.7-2.2 1.3-.7.6-1.2 1.3-1.6 2.3-.4 1-.7 2.2-.8 3.7h13zM562.9 114.7l-.1-2.9h4.6v4.1c.2-.3.4-.8.7-1.2.3-.5.8-1 1.3-1.5.6-.5 1.4-1 2.3-1.3.9-.3 2-.5 3.4-.5.6 0 1.4.1 2.4.2.9.2 1.9.5 2.9 1.1 1 .6 1.8 1.4 2.5 2.5.6 1.2 1 2.7 1 4.7V137h-4.6v-16c0-.9-.1-1.7-.2-2.4-.2-.7-.5-1.3-1.1-1.9-1.2-1.1-2.6-1.7-4.3-1.7-1.7 0-3.1.6-4.3 1.8-1.3 1.2-2 3.1-2 5.7V137h-4.6v-22.3zM607 119.8c0-.3 0-.8-.1-1.4-.1-.6-.3-1.1-.6-1.8-.2-.6-.7-1.2-1.4-1.6-.7-.4-1.6-.6-2.7-.6-1.5 0-2.7.4-3.5 1.2-.9.8-1.5 1.7-1.9 2.8-.4 1.1-.6 2.2-.7 3.2-.1 1.1-.2 1.8-.1 2.4 0 1.3.1 2.5.3 3.7.2 1.2.5 2.3.9 3.3.8 2 2.4 3 4.8 3.1 1.9 0 3.3-.7 4.1-1.9.8-1.1 1.2-2.3 1.2-3.6h4.6c-.2 2.5-1.1 4.6-2.7 6.3-1.7 1.8-4.1 2.7-7.1 2.7-.9 0-2.1-.2-3.6-.6-.7-.2-1.4-.6-2.2-1-.8-.4-1.5-1-2.2-1.7-.7-.9-1.4-2.1-2-3.6-.6-1.5-.9-3.5-.9-6.1 0-2.6.4-4.8 1.1-6.6.7-1.7 1.6-3.1 2.7-4.2 1.1-1 2.3-1.8 3.6-2.2 1.3-.4 2.5-.6 3.7-.6h1.6c.6.1 1.3.2 1.9.4.7.2 1.4.5 2.1 1 .7.4 1.3 1 1.8 1.7.9 1.1 1.4 2.1 1.7 3.1.2 1 .3 1.8.3 2.6H607zM629.1 137.1l-3.4 9.3H621l3.8-9.6-10.3-25h5.2l7.6 19.8 7.7-19.8h5z"/>
                </svg>
              </span>
            </a>
            <button class="usa-menu-btn usa-button l-header__menu-button">Menu</button>
          </div>
         
      <div class="l-header__nav">
        <nav class="usa-nav usa-nav--epa" role="navigation" aria-label="EPA header navigation">
          <div class="usa-nav__inner">
            <button class="usa-nav__close" aria-label="Close">
              <svg class="icon icon--nav-close" aria-hidden="true" role="img">
                <title>Primary navigation</title>
                <use xlink:href="https://www.epa.gov/themes/epa_theme/images/sprite.artifact.svg#close"></use>
              </svg> </button>
            <div class="usa-nav__menu">
               <ul class="menu menu--main">
                <li class="menu__item"><a href="https://github.com/David-Cola/David-Cola.github.io" class="menu__link">Ion Exchange Model</a></li>
                
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <main id="main" class="main" role="main" tabindex="-1">'
  ),
  
  tags$head(
    tags$style(HTML('.navbar-default .navbar-nav > li > a:hover, .navbar-default .navbar-nav > li > a:focus {
      color: #000; /*Sets the text hover color on navbar*/
    }
    
    .navbar-default .navbar-nav > .active > a, .navbar-default .navbar-nav > .active >
      a:hover, .navbar-default .navbar-nav > .active > a:focus {
        color: white; /*BACKGROUND color for active*/
          background-color: #0e6cb6;
      }
    
    .navbar-default {
      background-color: #0e6cb6;
        border-color: #030033;
    }
    
    
    
    .navbar-default .navbar-nav > li > a {
      color: white; /*Change active text color here*/
    }'))),
  
  tags$style(HTML("
    .tabbable > .nav > li > a                  {background-color: #D3D3D3;  color:black}
  ")),
  
  navbarPage("",
             
             tabPanel("Input", 
                      sidebarLayout(
                        sidebarPanel(fileInput("file1", "Choose .xlsx File", accept = ".xlsx"),
                                     textOutput("reject"),
                                     textOutput("OutputConcentration"),
                                     #selectInput("OCunits", "Output Concentration Units", c("mg/L", "ug/L", "ng/L", "c/c0")),
                                     #selectInput("timeunits","Output Time Units",c("Days", "Bed Volumes (x1000)", "Hours", "Months", "Years")),
                                     sliderInput("nrv", "Radial Collocation Points",3, 18, 7),
                                     sliderInput("nzv", "Axial Collocation Points", 3, 18, 13),
                                     br(),
                                     actionButton("run_button", "Run Analysis", icon=icon("play")),
                                     #downloadButton("save_button2", "Save Data"),
                                     textOutput("ionadded"),
                                     textOutput("concentrationadded"),
                                     textOutput("analysisran")),#sidebarPanel,
                        
                        mainPanel(
                          tabsetPanel(
                            tabPanel("Column Parameters",
                                     
                                     br(),
                                     
                                     fluidRow(
                                       column(3,),
                                       column(2, textOutput("Q")),
                                       column(2,shinyWidgets::autonumericInput(
                                         inputId = "Qv",
                                         label="",
                                         value = 1400, 
                                         decimalPlaces = 2,
                                         digitGroupSeparator = ",",
                                         decimalCharacter = ".")),
                                        column(3, selectInput("qunits", "", c("meq/L")))), 
                                              
                                      fluidRow(
                                        column(3, textOutput("RC")),
                                        column(2, textOutput("rb")),
                                        column(2, shinyWidgets::autonumericInput(
                                          inputId = "rbv",
                                          label="",
                                          value = 0.03375, 
                                          decimalPlaces = 5,
                                          digitGroupSeparator = ",",
                                          decimalCharacter = ".")),
                                        column(3, selectInput("rbunits", "", c("cm", "m", "mm", "in", "ft")))
                                      ),
                                     
                                     fluidRow(
                                       column(3, ),
                                       column(2, textOutput("EBED")),
                                       column(2, shinyWidgets::autonumericInput(
                                         inputId = "EBEDv",
                                         label="",
                                         value = 0.35, 
                                         currencySymbolPlacement = "p",
                                         decimalPlaces = 3,
                                         digitGroupSeparator = ",",
                                         decimalCharacter = "."
                                       ))
                                              
                                     ),
                                       
                                       
                                     hr(),
                                     #Parameters Row 2#
                                     
                                     fluidRow(
                                       column(3,
                                              br(), br(), br(),
                                              textOutput("CS"),
                                              br(),
                                              radioButtons("veloselect", "", c("Linear", "Volumetric"))),
                                       column(2, #offset=1,
                                              br(), 
                                              textOutput("Length"),
                                              br(), br(), 
                                              textOutput("Velocity"),
                                              br(), br(), 
                                              textOutput("Diameter"),
                                              br(), br(),
                                              textOutput("Flowrate")),
                                       column(2,
                                              
                                              shinyWidgets::autonumericInput(
                                                inputId = "Lv",
                                                label="",
                                                value = 14.765, 
                                                decimalPlaces = 3,
                                                digitGroupSeparator = ",",
                                                decimalCharacter = "."),
                                              
                                              shinyWidgets::autonumericInput(
                                                inputId = "Vv",
                                                label="",
                                                value = 0.123, 
                                                decimalPlaces = 3,
                                                digitGroupSeparator = ",",
                                                decimalCharacter = "."),
                                              
                                              
                                              shinyWidgets::autonumericInput(
                                                inputId = "Dv",
                                                label="",
                                                value = 4, 
                                                decimalPlaces = 3,
                                                digitGroupSeparator = ",",
                                                decimalCharacter = "."),
                                              
                                              shinyWidgets::autonumericInput(
                                                inputId = "Fv",
                                                label="",
                                                value = 1.546, 
                                                decimalPlaces = 5,
                                                digitGroupSeparator = ",",
                                                decimalCharacter = ".")),
                                       
                                       column(3,
                                              selectInput("LengthUnits", "", c("cm", "m", "mm", "in", "ft")),
                                              div(style="margin-top:-0.5em",
                                                  selectInput("VelocityUnits", "", c("cm/s", "m/s", "m/min", "m/h", "in/s","ft/s","ft/min", "gpm/ft^2"))),
                                              
                                              div(style ="
                                              margin-top:-0.5em", 
                                                  selectInput("DiameterUnits","",c("cm", "m", "in", "ft")),
                                                  selectInput("FlowrateUnits","",c("cm^3/s", "m^3/s", "ft^3/s", "mL/s", "L/min", "mL/min", "gpm", "mgd"))))),
                                     hr(),
                                     #Parameters Row 4#
                                     
                                     fluidRow(
                                       column(3,
                                              br(),
                                              textOutput("conctime")),
                                       column(3, offset=4,
                                              div(style ="
                                              margin-top:-0.5em",
                                                  selectInput("timeunits2", "", c("hr", "day")),
                                                  br(), br()))),
                                     
                                     
                            ),
                            tabPanel("Ions",
                                     h4("Ion List"),
                                     dataEditUI("edit-1"),
                                     br(), br(),
                                     h4("Concentration Points"),
                                     dataEditUI("edit-2"),
                                     br(), br()
                            ))
                          
                          
                        )#mainPanel
                      ),#sidebarLayout
                      
             ),#navbarPage
             tabPanel("Output",
                      
                      sidebarLayout(
                        sidebarPanel(
                          selectInput("OCunits", "Output Concentration Units", c("mg/L", "ug/L", "ng/L", "c/c0")),
                          selectInput("timeunits","Output Time Units",c("Days", "Bed Volumes (x1000)", "Hours", "Months", "Years")),
                          #actionButton("run_button", "Run Analysis", icon=icon("play")),
                          downloadButton("save_button", "Save Data")
                        ),
                        
                        mainPanel(
                          
                          shinycssloaders::withSpinner(
                            plotlyOutput("Plot")),
                          br(),
                          plotlyOutput("ExtraChemicals")))),
             
             tabPanel("About",
                      ("The Ion Exchange Model is a tool used to model a strong-base anion exchange unit operation in a drinking water treatment plant. This model relies on selectivity coefficient parameters and other information about the anion exchange resin and predicts the breakthrough behavior for unit operation design."),
                      br(), br(),
                      tags$a(href="https://github.com/USEPA/Water_Treatment_Models/", "Click here to read more about the Ion Exchange Model"),
                      br(), br(),
                      strong("There are two ways to start this model:"), br(),
                      ("1) Use an Excel file to describe parameters of the water treatment unit operation (examples provided). Files can be uploaded by clicking 'Browse' in the top left corner of the Input page."),br(),
                      ("2) Start with the data that is provided in the user interface and manipulate the data from there. "),br(),
                      br(),("Enter information into Column Parameters tab, then add concentration and other ion information in the Ions tab. These can be adjusted within the GUI or saved in an .xlsx file to reuse in the future. Click 'Run Analysis' to begin the simulation. Simulation time can take a few seconds to minutes (20 + seconds) depending on how many ions are simulated."),
                      br(),br(),
                      strong("Developed By"),br(),
                      ("David Colantonio"),br(),
                      ("Levi Haupert"),br(),
                      ("Jonathan Burkhardt"),)
  )
)
#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
#~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
#------------------------------------------------------------------------------#
#BEGIN SERVER#
#------------------------------------------------------------------------------#


server <- function(input, output, session) {
  
  
  
  #------------------------------------------------------------------------------#
  #STATIC DISPLAY TEXTS#
  #------------------------------------------------------------------------------#
  
  output$Q<-renderText("Resin Capacity")
  output$rb<-renderText("Bead Radius")
  output$EBED<-renderText("Bed Porosity")
  output$name<-renderText("Name")
  
  output$CS<-renderText("Column Specifications")
  output$MC<-renderText("Material Characteristics")
  output$CS3<-renderText("Solver Related")
  
  output$Length<-renderText("Length")
  output$Velocity<-renderText("Velocity")
  output$Diameter<-renderText("Diameter")
  output$Flowrate<-renderText("Flow Rate")
  
  output$kL<-renderText("Film Transfer Coefficient")
  output$Ds<-renderText("Surface Diffusion Coefficient")
  
  output$RC<-renderText("Resin Characteristics")
  
  output$SR<-renderText("Solver Related")
  output$nr<-renderText("Radial Collocation Points")
  output$nz<-renderText("Axial Collocation Points")
  
  output$conctime<-renderText("Time")
  output$TS<-renderText("Time Step")
  
  output$ChemicalNames<-renderText("Chemical Names")
  output$mw<-renderText("mw")
  output$KxA<-renderText("KxA")
  output$Valence<-renderText("Valence")
  
  output$Name2<-renderText("Name")
  output$InitialTime<-renderText("Inital")
  output$FinalTime<-renderText("Final")
  
  output$OC<-renderText("Units")
  
  output$IonList<-renderText("Ion List")
  output$ConcentrationList<-renderText("Concentration Points")
  
  
  #------------------------------------------------------------------------------#
  #INPUT FILE HANDLING#
  #------------------------------------------------------------------------------#
  
  #The function process_files was defined at the beginning, now it is being called
  #When a file is inputted into the UI
  observeEvent(input$file1, {
    file <- input$file1
    process_files(file$datapath)
  })
  
  #GUI rejects a file upload that is not an xlsx
  output$reject<-renderPrint({
    req(input$file1)
    if(input$file1$type != "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"){ stop("Please upload a .xlsx file")}
  })
  
  ### TODO: Should the reject be within the process_files? Or somehow before that.... so merging the above 2 items?
  
  #When a file is uploaded, the session is reloaded. We do this because there does
  #Not seem to be any other way to overwrite the DataEditR tables. See the process_file
  #Notes for further elaboration.
  observeEvent(input$file1, {
    session$reload()
  })
  
  
  
  #------------------------------------------------------------------------------#
  #PARAMS DATA HANDLING#
  #------------------------------------------------------------------------------#  
  
  #When the param sheet is read in, make it a reactiveVal so that the data can
  #Be saved between refreshes and edited
  paramsheet<-reactiveVal(read.csv("paramsheet.csv"))
  
  
  ##Flow rate V. Linear Velocity
  ##Some water treatment users may want to use a linear velocity and some may want to use a flow rate
  ##Given that we can have one option, both options, or neither
  
  
  test_df<-data.frame(C=c('v','flrt','diam'))
  flags<-reactive({test_df$C %in% paramsheet()$name}) ##flags are in order [1] velocity [2] flowrate and [3] diameter
  
  velocity<-reactiveVal()
  velocityvector2<-reactiveVal()
  velocityvector3<-reactiveVal()
  
  flowrate<-reactiveVal()
  flowrate2<-reactiveVal()
  flowrate3<-reactiveVal()
  
  diameter<-reactiveVal()
  diameter2<-reactiveVal()
  diameter3<-reactiveVal()
  
  
  observe({if (flags()[1]){
    # velocity read in
    velocity(filter(paramsheet(), name=='v')$value)
    updateNumericInput(session, "Vv", value=velocity())
                                                                                                                               
    velocityvector2(c(filter(paramsheet(), name=='v')$units, velocityvector))
    velocityvector3<-unique(velocityvector2())
    
    updateSelectInput(session, "VelocityUnits", choices=velocityvector3())

    ##add toggle of velocity selector
    updateRadioButtons(session, "veloselect", selected="Linear")

  }
    else if(flags()[2] & flags()[3]){
      
      flowrate(filter(paramsheet(), name=='flrt')$value)
      diameter(filter(paramsheet(), name=='diam')$value)
     
     updateNumericInput(session, "Fv", value=flowrate())
     updateNumericInput(session, "Dv", value=diameter())
     
     
     flowrate2(c(filter(paramsheet(), name=='flrt')$units, flowratevector))
     flowrate3(unique(flowrate2()))
     
     diameter2(c(filter(paramsheet(), name=='diam')$units, diametervector))
     diameter3(unique(diameter2()))
     
     updateSelectInput(session, "FlowrateUnits", choices=flowrate3())
     updateSelectInput(session, "DiameterUnits", choices=diameter3())                                     
     
     updateRadioButtons(session, "veloselect", selected="Volumetric")
    }
    else{
     print("Warning: No flow data provided, defaults used")
    }

    })
  
    
  #Take the data from the file that the user uploaded and overwrite the default frame
  capacity<-reactive({filter(paramsheet(), name=="Q")$value})
  eebed<-reactive({filter(paramsheet(), name=="EBED")$value})
  length2<-reactive({filter(paramsheet(), name=="L")$value})
  beadradius<-reactive({filter(paramsheet(), name=="rb")$value})
  film<-reactive({filter(paramsheet(), name=="kL")$value})
  diffuse<-reactive({filter(paramsheet(), name=="Ds")$value})
  radial<-reactive({filter(paramsheet(), name=="nr")$value})
  axial<-reactive({filter(paramsheet(), name=="nz")$value})
  time<-reactive({filter(paramsheet(), name=="time")$value})
  
  observe({
    updateNumericInput(session, "Qv", value=format(capacity(), digits=4, scientific=FALSE))
    updateNumericInput(session, "EBEDv", value=format(eebed(), digit=4, scientific=FALSE))
    updateNumericInput(session, "Lv", value=length2())
    updateNumericInput(session, "rbv", value=prettyNum(beadradius(), digits=4, scientific=FALSE))
    updateNumericInput(session, "kLv", value=film())
    updateNumericInput(session, "Dsv", value=diffuse())
    updateNumericInput(session, "nrv", value=radial())
    updateNumericInput(session, "nzv", value=axial())
  })
  
  
  
  #This is the to update the selectInput to the unit that you have in the excel
  #file. There doesn't seem to be a direct way to update to the selectInput to the one in
  #the xlsx file, but, you can update the options as a whole. So, I create a vector
  #of all the unit options, then take the unit you have in your file and combine them
  #into one vector. The value in your excel file becomes the first value in the combined vector. 
  #Then from there
  #I run it through a unique() function which gets rid of the duplicate in your vector
  #Then, I can update the selectInput vector where it has reorganized your  initial
  #vector to start
  #with the users input.
  
  ## TODO: Time and units aren't getting pulled in from file.
  
  
  lengthvector2<-reactive({c(filter(paramsheet(), name=="L")$units, lengthvector)})
  lengthvector3<-reactive({unique(lengthvector2())})
  
  rbvector<-reactive({c(filter(paramsheet(), name=='rb')$units, lengthvector)})
  rbvector2<-reactive({unique(rbvector())})
  
  timevector2<-reactive(c(filter(paramsheet(), name=='time')$units, timevector))
  timevector3<-reactive({unique(timevector2())})
  
  observe({
    updateSelectInput(session, "rbunits", choices=rbvector2())
    updateSelectInput(session, "LengthUnits", choices=lengthvector3())
    updateSelectInput(session, "timeunits2", choices=timevector3())
    })
  
  observe({
    toggleState("Vv", condition=input$veloselect!="Volumetric")
    toggleState("Fv", condition=input$veloselect!="Linear")
    toggleState("Dv", condition=input$veloselect!="Linear")
  })
  
  velocityvar<-reactiveVal()
  
  #output$sum2<-renderTable(velocityvector())
  
  #------------------------------------------------------------------------------#
  #IONS DATA HANDLING#
  #------------------------------------------------------------------------------#  
  
  iondat<- dataEditServer("edit-1", data = "ionsheet.csv") 
  dataOutputServer("output-1", data = iondat)
  
  cindat<-dataEditServer("edit-2",read_args=list(colClasses=c("numeric")),data="cinsheet.csv") ## read_args should make all columns numeric, which seems to address the "initial read in as integer issues"
  dataOutputServer("output-2", data = cindat)
  
  #------------------------------------------------------------------------------#
  #CALLING THE HSDMIX FUNCTION#
  #------------------------------------------------------------------------------#    
  
  out<-reactiveVal()
  
  observeEvent(input$run_button, {
    out(HSDMIX_prep(input, iondat(), cindat(), nt_report))
  })
  
  # find outlet indices
  outlet_id <- reactive({dim(out()[[2]])[4]})
  liquid_id <- reactive({dim(out()[[2]])[2]})
  
  #------------------------------------------------------------------------------#
  #                 IEX CONCENTRATION OUTPUT DATAFRAME                           #
  #------------------------------------------------------------------------------#
  ### TODO: add better error handling HSDMIX_prep can now return an 'error' value which is an integer, or the full data
  #### only want to proceed if it isn't an error state
  
  timeframe<-reactive({data.frame(hours=out()[[1]])})
  allchemicalconcs<-list()
  
  allchemicals<-eventReactive(input$run_button, {for (x in 1:nrow(iondat())){
    conc<-out()[[2]][, liquid_id(), x, outlet_id()]
    allchemicalconcs[[x]]<-conc
  }
    allconcdf<-data.frame(allchemicalconcs)
    colnames(allconcdf)<-iondat()$name
    allconcdf
  })
  
  massvector<-reactive({c(iondat()$mw/iondat()$valence)})
  allchemicalscorrected<-reactive({mapply('*', allchemicals(), massvector())})
  allchemicalscorrected2<-reactive({data.frame(allchemicalscorrected())})
  allchemicalscorrected3<-reactive({tidyr::gather(allchemicalscorrected2())})
  allchemicalscorrected4<-reactive({data.frame(name=allchemicalscorrected3()[,1],
                                               conc=allchemicalscorrected3()[,2])})
  allchems<-reactive({cbind(timeframe(), allchemicalscorrected4())})
  
  allchemicals2<-reactive({cbind(timeframe(), allchemicals())})
  
  #------------------------------------------------------------------------------#
  #                   END IEX CONCENTRATION OUTPUTDATAFRAME#
  #------------------------------------------------------------------------------#
  #~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
  
  #------------------------------------------------------------------------------#
  #GENERATE C/C0 DATAFRAMES FROM MG/L CONCENTRATION DATAFRAMES#
  
  #The goal here is: For each column in allchemicals, divide every element
  #in each column by the first value in that column.
  #------------------------------------------------------------------------------#
  ## need to create meq/L c0 for math to work out
  cc0vector<-reactive({cc0_conv(iondat(), cindat())})
  allchemicalscc0<-reactive({mapply('/', allchemicals(), cc0vector())})
  allchemicalscc02<-reactive(data.frame(allchemicalscc0()))
  allchemicalscc03<-reactive({tidyr::gather(allchemicalscc02())})
  allchemicalscc04<-reactive({data.frame(name=allchemicalscc03()[,1],
                                         conc=allchemicalscc03()[,2])})
  
  #------------------------------------------------------------------------------#
  #END IEX CONCENTRATION OUTPUTDATAFRAME#
  #------------------------------------------------------------------------------#
  #~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
  
  #------------------------------------------------------------------------------#
  #CONVERSION OF DATAFRAMES#
  #------------------------------------------------------------------------------#
  
  bonusdataframe<-data.frame(hours=c(), conc=c())
  
  allconcsconvert<-eventReactive(input$run_button, {for (x in 1:nrow(data_edit())){
   
    dx_frame<-data.frame(
      hours=out()[[1]], conc=out()[[2]][, liquid_id(), x, outlet_id()], name=data_edit()[x,1]
    )
    bonusdataframe<-rbind(bonusdataframe, dx_frame)
    
  }
    bonusdataframe
  })
  
  chemnames<-reactive({allconcsconvert()$name})
  allconcscc0<-reactive({rbind(allconcscc02(), chemnames())})
  
  
  #------------------------------------------------------------------------------#
  #END INITIALIZING CONVERSION FRAMES#
  #------------------------------------------------------------------------------#
  #~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*~*#
  
  #------------------------------------------------------------------------------#
  #CONVERTING OUTPUT DATAFRAMES#
  #------------------------------------------------------------------------------#
  allchemicals2<-reactive({cbind(timeframe(), allchemicals())})
  
  outputcounterions<-reactiveValues(counterion=0)
  outputions<-reactiveValues(ion=0)
  
  # 804 == 4 * nt_report
  counterIon_loc = 4 * nt_report
  addIon_loc = counterIon_loc + 1
  counteriondata<-reactive({allchems()[0:counterIon_loc,]})
  iondata<-reactive({allchems()[addIon_loc:nrow(allchems()),]})
  
  counteriondatacc0<-reactive({allchemicalscc04()[0:counterIon_loc,]})
  iondatacc0<-reactive({allchemicalscc04()[addIon_loc:nrow(allchems()),]})
  
  outputcounterions$name<-reactive({counteriondata()$name})
  outputions$name<-reactive({iondata()$name})
  
  observe({
    req(allchemicals2())
    ## convert time units for graphing
    # calculating kBV
    if (input$timeunits == "Bed Volumes (x1000)") {
      bv_conv <- get_bv_in_sec(input)
      outputcounterions$time <- counteriondata()$hours / (bv_conv / hour2sec) / 1e3
      outputions$time <- iondata()$hours / (bv_conv / hour2sec) / 1e3
    } else {
      outputcounterions$time <- counteriondata()$hours / (time_conv[input$timeunits] / hour2sec)
      outputions$time <- iondata()$hours / (time_conv[input$timeunits] / hour2sec)
    }
  })
  
  observe({
    req(allchemicals2())
    ### convert y-axis/mass units for graphing
    if(input$OCunits=="c/c0"){
      ## just replicates the returned data
      outputcounterions$conc <-  counteriondatacc0()$conc
      outputions$conc <- iondatacc0()$conc
    } else {
      outputcounterions$conc <- counteriondata()$conc / mass_conv[input$OCunits]
      outputions$conc <- iondata()$conc / mass_conv[input$OCunits]
      
    }
    
  })
  
  ### graph data
  processed_data <- reactive({
    
    plot_data <- counteriondata()
    plot_data$conc <- outputcounterions$conc
    plot_data$hours <- outputcounterions$time
    plot_data
    
  })
  
  processed_data2 <- reactive({
    
    plot_data2 <- iondata()
    plot_data2$conc <- outputions$conc
    plot_data2$hours <- outputions$time
    plot_data2
    
  })
  
  fig<-reactive({plot_ly(processed_data(), x=~hours, y=~conc,type='scatter', mode="lines", color=~name, colors=SteppedSequential5Steps)})
  fig2<-reactive({fig()%>%layout(title="Concentration over Time",
                                 legend=list(orientation='h', y=1),
                                 xaxis=list(title=input$timeunits),
                                 yaxis=list(title=paste0("Concentration (",input$OCunits,")")))})
  
  bonusfig<-reactive({plot_ly(processed_data2(), x=~hours, y=~conc,type='scatter', mode="lines", color=~name, colors=SteppedSequential5Steps)})
  bonusfig2<-reactive({bonusfig()%>%layout(title="Concentration over Time", showlegend=TRUE,
                                           legend=list(orientation='h', y=1),
                                           xaxis=list(title=input$timeunits),
                                           yaxis=list(title=paste0("Concentration (",input$OCunits,")"), showexponent='all', exponentformat='e'))})
  
  
  output$Plot<-renderPlotly(
    fig2())
  
  output$ExtraChemicals <- renderPlotly(
    bonusfig2())
  
  
  ### TODO: Can we make this file name dynamic? otherwise we'll just overwrite the previous file.
  output$save_button<-downloadHandler(
    filename=function(){"IEX_Data.xlsx"},
    content=function(file){
      write.xlsx(paramsheet(), filename, sheetName="params")
      write.xlsx(iondat(), sheetName="ions", filename, append=TRUE)
      write.xlsx(cindat(), sheetName="cin", filename, append=TRUE)
      write.xlsx(allchemicals2(), sheetName="output", filename, append=TRUE)
    }
    
  )
  
}



shinyApp(ui, server)